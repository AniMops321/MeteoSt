<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–µ—Ç–µ–æ—Å—Ç–∞–Ω—Ü–∏—è</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>–ú–µ—Ç–µ–æ—Å—Ç–∞–Ω—Ü–∏—è</h1>
  <div class="nav">
    <a href="/archive" class="button">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∞—Ä—Ö–∏–≤</a>
  </div>

  <div class="data" id="weather">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <canvas id="chart" width="600" height="300"></canvas>

  <script>
    let chart;

    async function fetchData() {
      const res = await fetch("/data");
      const data = await res.json();
      const el = document.getElementById("weather");

      if (data.error) {
        el.textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
      } else {
        el.innerHTML = `
          üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${data.temperature} ¬∞C<br>
          üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: ${data.humidity} %<br>
          üß≠ –î–∞–≤–ª–µ–Ω–∏–µ: ${data.pressure} –≥–ü–∞<br>
          ‚òÄÔ∏è –û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å: ${data.lux} lx<br>
          ‚è± –í—Ä–µ–º—è: ${new Date(data.timestamp).toLocaleTimeString()}
        `;
      }
    }

    async function drawChart() {
      const res = await fetch("/log");
      const log = await res.json();

      const labels = log.map(e => new Date(e.timestamp).toLocaleTimeString());
      const temp = log.map(e => e.temperature);
      const hum = log.map(e => e.humidity);
      const lux = log.map(e => e.lux);

      const ctx = document.getElementById("chart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)', data: temp, borderColor: 'red', fill: false },
            { label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)', data: hum, borderColor: 'blue', fill: false },
            { label: '–û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å (lx)', data: lux, borderColor: 'goldenrod', fill: false }
          ]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    setInterval(() => {
      fetchData();
      drawChart();
    }, 5000);

    fetchData();
    drawChart();
  </script>
</body>
</html>
